{% extends "base.html" %}

{% block title %}Planespotter - Network Connectivity{% endblock %}

{% block content %}
<div class="d-flex align-items-center mb-4">
    <i class="bi bi-diagram-3 fs-3 me-3" style="color: var(--ps-sky);"></i>
    <div>
        <h2 class="mb-0">Network Connectivity</h2>
        <p class="text-muted mb-0">Micro-segmentation visualization - test service-to-service connections</p>
    </div>
    <div class="ms-auto">
        <button onclick="location.reload()" class="btn btn-primary">
            <i class="bi bi-arrow-clockwise me-2"></i>Test Connections
        </button>
    </div>
</div>

{% if connectivity %}
<!-- Summary Banner -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row align-items-center">
            <div class="col-auto">
                {% if connectivity.summary.status == 'healthy' %}
                <div class="status-card healthy" style="padding: 1.5rem;">
                    <i class="bi bi-shield-check fs-1"></i>
                </div>
                {% elif connectivity.summary.status == 'degraded' %}
                <div class="status-card degraded" style="padding: 1.5rem;">
                    <i class="bi bi-shield-exclamation fs-1"></i>
                </div>
                {% else %}
                <div class="status-card unhealthy" style="padding: 1.5rem;">
                    <i class="bi bi-shield-x fs-1"></i>
                </div>
                {% endif %}
            </div>
            <div class="col">
                <h3 class="mb-1">
                    {% if connectivity.summary.blocked == 0 %}
                    <span class="text-success">All Connections Active</span>
                    {% elif connectivity.summary.connected > 0 %}
                    <span style="color: var(--ps-amber);">Partial Connectivity</span>
                    {% else %}
                    <span class="text-danger">Connections Blocked</span>
                    {% endif %}
                </h3>
                <p class="text-muted mb-0">
                    <span class="badge bg-success me-2">{{ connectivity.summary.connected }} Connected</span>
                    <span class="badge bg-danger">{{ connectivity.summary.blocked }} Blocked</span>
                </p>
            </div>
            <div class="col-auto text-end">
                <small class="text-muted d-block">Last tested</small>
                <small>{{ connectivity.timestamp }}</small>
            </div>
        </div>
    </div>
</div>

<!-- Visual Network Diagram -->
<div class="card mb-4">
    <div class="card-header">
        <i class="bi bi-bezier2 me-2"></i>Network Topology
    </div>
    <div class="card-body">
        <div class="network-diagram">
            <svg viewBox="0 0 800 400" class="w-100" style="max-height: 400px;">
                <!-- Definitions for markers and gradients -->
                <defs>
                    <marker id="arrow-green" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                        <path d="M0,0 L0,6 L9,3 z" fill="#4ade80"/>
                    </marker>
                    <marker id="arrow-red" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                        <path d="M0,0 L0,6 L9,3 z" fill="#f87171"/>
                    </marker>
                    <filter id="glow-green">
                        <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
                        <feMerge>
                            <feMergeNode in="coloredBlur"/>
                            <feMergeNode in="SourceGraphic"/>
                        </feMerge>
                    </filter>
                    <filter id="glow-red">
                        <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
                        <feMerge>
                            <feMergeNode in="coloredBlur"/>
                            <feMergeNode in="SourceGraphic"/>
                        </feMerge>
                    </filter>
                </defs>

                <!-- Background grid -->
                <pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse">
                    <path d="M 40 0 L 0 0 0 40" fill="none" stroke="rgba(74, 158, 255, 0.1)" stroke-width="1"/>
                </pattern>
                <rect width="100%" height="100%" fill="url(#grid)"/>

                <!-- Connection Lines -->
                {% for conn in connectivity.connections %}
                {% if conn.id == 'api-to-db' %}
                <line x1="400" y1="120" x2="200" y2="280"
                      stroke="{{ '#4ade80' if conn.status == 'connected' else '#f87171' }}"
                      stroke-width="3"
                      marker-end="url(#arrow-{{ 'green' if conn.status == 'connected' else 'red' }})"
                      filter="url(#glow-{{ 'green' if conn.status == 'connected' else 'red' }})"
                      class="connection-line {% if conn.status != 'connected' %}blocked{% endif %}"/>
                {% elif conn.id == 'api-to-valkey' %}
                <line x1="400" y1="120" x2="400" y2="280"
                      stroke="{{ '#4ade80' if conn.status == 'connected' else '#f87171' }}"
                      stroke-width="3"
                      marker-end="url(#arrow-{{ 'green' if conn.status == 'connected' else 'red' }})"
                      filter="url(#glow-{{ 'green' if conn.status == 'connected' else 'red' }})"
                      class="connection-line {% if conn.status != 'connected' %}blocked{% endif %}"/>
                {% elif conn.id == 'api-to-opensky' %}
                <line x1="400" y1="120" x2="600" y2="280"
                      stroke="{{ '#4ade80' if conn.status == 'connected' else '#f87171' }}"
                      stroke-width="3"
                      marker-end="url(#arrow-{{ 'green' if conn.status == 'connected' else 'red' }})"
                      filter="url(#glow-{{ 'green' if conn.status == 'connected' else 'red' }})"
                      class="connection-line {% if conn.status != 'connected' %}blocked{% endif %}"/>
                {% endif %}
                {% endfor %}

                <!-- Frontend to API line (always connected if page loads) -->
                <line x1="400" y1="30" x2="400" y2="70"
                      stroke="#4ade80" stroke-width="3"
                      marker-end="url(#arrow-green)"
                      filter="url(#glow-green)"/>

                <!-- Service Nodes -->
                <!-- Frontend -->
                <g transform="translate(400, 30)">
                    <circle r="25" fill="#132238" stroke="#4a9eff" stroke-width="2"/>
                    <text y="5" text-anchor="middle" fill="#fff" font-size="12">FE</text>
                </g>
                <text x="400" y="-5" text-anchor="middle" fill="#94a3b8" font-size="11">Frontend</text>

                <!-- API Server -->
                <g transform="translate(400, 120)">
                    <circle r="35" fill="#132238" stroke="#4a9eff" stroke-width="3"/>
                    <text y="5" text-anchor="middle" fill="#fff" font-size="14" font-weight="bold">API</text>
                </g>
                <text x="400" y="170" text-anchor="middle" fill="#94a3b8" font-size="11">API Server</text>

                <!-- PostgreSQL -->
                <g transform="translate(200, 300)">
                    {% set db_conn = connectivity.connections | selectattr('id', 'eq', 'api-to-db') | first %}
                    <circle r="30" fill="#132238"
                            stroke="{{ '#4ade80' if db_conn.status == 'connected' else '#f87171' }}"
                            stroke-width="2"/>
                    <text y="5" text-anchor="middle" fill="#fff" font-size="12">DB</text>
                </g>
                <text x="200" y="345" text-anchor="middle" fill="#94a3b8" font-size="11">PostgreSQL</text>
                <text x="200" y="360" text-anchor="middle" fill="#94a3b8" font-size="10">:5432</text>

                <!-- Valkey -->
                <g transform="translate(400, 300)">
                    {% set valkey_conn = connectivity.connections | selectattr('id', 'eq', 'api-to-valkey') | first %}
                    <circle r="30" fill="#132238"
                            stroke="{{ '#4ade80' if valkey_conn.status == 'connected' else '#f87171' }}"
                            stroke-width="2"/>
                    <text y="5" text-anchor="middle" fill="#fff" font-size="12">VK</text>
                </g>
                <text x="400" y="345" text-anchor="middle" fill="#94a3b8" font-size="11">Valkey</text>
                <text x="400" y="360" text-anchor="middle" fill="#94a3b8" font-size="10">:6379</text>

                <!-- OpenSky -->
                <g transform="translate(600, 300)">
                    {% set opensky_conn = connectivity.connections | selectattr('id', 'eq', 'api-to-opensky') | first %}
                    <circle r="30" fill="#132238"
                            stroke="{{ '#4ade80' if opensky_conn.status == 'connected' else '#f87171' }}"
                            stroke-width="2"/>
                    <text y="5" text-anchor="middle" fill="#fff" font-size="10">EXT</text>
                </g>
                <text x="600" y="345" text-anchor="middle" fill="#94a3b8" font-size="11">OpenSky</text>
                <text x="600" y="360" text-anchor="middle" fill="#94a3b8" font-size="10">:443</text>

                <!-- Legend -->
                <g transform="translate(50, 380)">
                    <line x1="0" y1="0" x2="30" y2="0" stroke="#4ade80" stroke-width="3"/>
                    <text x="40" y="4" fill="#94a3b8" font-size="11">Connected</text>
                    <line x1="120" y1="0" x2="150" y2="0" stroke="#f87171" stroke-width="3" stroke-dasharray="5,5"/>
                    <text x="160" y="4" fill="#94a3b8" font-size="11">Blocked</text>
                </g>
            </svg>
        </div>
    </div>
</div>

<!-- Connection Details Table -->
<div class="card">
    <div class="card-header">
        <i class="bi bi-list-check me-2"></i>Connection Details
    </div>
    <div class="table-responsive">
        <table class="table mb-0">
            <thead class="table-light">
                <tr>
                    <th>Status</th>
                    <th>Source</th>
                    <th></th>
                    <th>Destination</th>
                    <th>Port</th>
                    <th>Protocol</th>
                    <th>Latency</th>
                    <th>Details</th>
                </tr>
            </thead>
            <tbody>
                <!-- Frontend to API (always works if page loaded) -->
                <tr>
                    <td>
                        <span class="badge bg-success">
                            <i class="bi bi-check-circle me-1"></i>Connected
                        </span>
                    </td>
                    <td><i class="bi bi-window me-2"></i>Frontend</td>
                    <td><i class="bi bi-arrow-right" style="color: var(--ps-green);"></i></td>
                    <td><i class="bi bi-cpu me-2"></i>API Server</td>
                    <td><code>8000</code></td>
                    <td>HTTP</td>
                    <td><span class="text-success">&lt; 10 ms</span></td>
                    <td><small class="text-muted">Page loaded successfully</small></td>
                </tr>
                {% for conn in connectivity.connections %}
                <tr>
                    <td>
                        {% if conn.status == 'connected' %}
                        <span class="badge bg-success">
                            <i class="bi bi-check-circle me-1"></i>Connected
                        </span>
                        {% else %}
                        <span class="badge bg-danger">
                            <i class="bi bi-x-circle me-1"></i>Blocked
                        </span>
                        {% endif %}
                    </td>
                    <td><i class="bi bi-cpu me-2"></i>{{ conn.source }}</td>
                    <td>
                        <i class="bi bi-arrow-right" style="color: var(--ps-{{ 'green' if conn.status == 'connected' else 'red' }});"></i>
                    </td>
                    <td>
                        {% if conn.destination == 'PostgreSQL' %}
                        <i class="bi bi-database me-2"></i>
                        {% elif conn.destination == 'Valkey' %}
                        <i class="bi bi-lightning-charge me-2"></i>
                        {% else %}
                        <i class="bi bi-cloud me-2"></i>
                        {% endif %}
                        {{ conn.destination }}
                    </td>
                    <td><code>{{ conn.port }}</code></td>
                    <td>{{ conn.protocol }}</td>
                    <td>
                        {% if conn.status == 'connected' %}
                        <span class="text-success">{{ conn.latency_ms }} ms</span>
                        {% else %}
                        <span class="text-danger">-</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if conn.error %}
                        <small class="text-danger">{{ conn.error }}</small>
                        {% else %}
                        <small class="text-muted">OK</small>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Demo Instructions -->
<div class="card mt-4">
    <div class="card-header">
        <i class="bi bi-lightbulb me-2"></i>Micro-Segmentation Demo
    </div>
    <div class="card-body">
        <p>Use this page to demonstrate NSX micro-segmentation capabilities:</p>
        <ol class="mb-0">
            <li class="mb-2">
                <strong>Baseline:</strong> All connections should show as <span class="badge bg-success">Connected</span>
            </li>
            <li class="mb-2">
                <strong>Apply Firewall Rule:</strong> Block traffic between API Server and PostgreSQL (TCP 5432)
            </li>
            <li class="mb-2">
                <strong>Observe:</strong> Click "Test Connections" to see the blocked connection turn <span class="badge bg-danger">Blocked</span>
            </li>
            <li class="mb-2">
                <strong>Remove Rule:</strong> Remove the firewall rule and test again to restore connectivity
            </li>
        </ol>
    </div>
</div>

{% else %}
<!-- Connection Failed -->
<div class="alert alert-danger d-flex align-items-center">
    <i class="bi bi-exclamation-triangle me-2"></i>
    Unable to connect to API server. Please ensure all services are running.
</div>
{% endif %}

<style>
.connection-line {
    transition: stroke 0.3s ease;
}
.connection-line.blocked {
    stroke-dasharray: 10, 5;
    animation: dash 1s linear infinite;
}
@keyframes dash {
    to {
        stroke-dashoffset: -15;
    }
}
.network-diagram {
    background: var(--ps-navy);
    border-radius: 0.75rem;
    padding: 1rem;
}
</style>
{% endblock %}

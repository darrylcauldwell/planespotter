{% extends "base.html" %}

{% block title %}Planespotter - Network Connectivity{% endblock %}

{% block content %}
<!-- Microservices Architecture -->
<div class="card mb-4">
    <div class="card-header flex items-center">
        <i class="bi bi-diagram-3 mr-2"></i>Microservices Architecture
    </div>
    <div class="card-body">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 items-center">
            <div class="lg:col-span-7">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 680 340" fill="none" style="width: 100%;">
                  <defs>
                    <marker id="ah" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
                      <polygon points="0 0, 8 3, 0 6" fill="var(--ps-text-muted)"/>
                    </marker>
                    <marker id="ah-blue" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
                      <polygon points="0 0, 8 3, 0 6" fill="var(--ps-sky)"/>
                    </marker>
                  </defs>
                  <!-- Row 1: Browser → Frontend → API Server -->
                  <rect x="20" y="30" width="120" height="55" rx="8" fill="transparent" stroke="var(--ps-sky)" stroke-width="2"/>
                  <text x="80" y="55" text-anchor="middle" font-family="system-ui, sans-serif" font-size="13" font-weight="600" fill="var(--ps-text)">Browser</text>
                  <text x="80" y="70" text-anchor="middle" font-family="system-ui, sans-serif" font-size="11" fill="var(--ps-text-muted)">Client</text>
                  <line x1="140" y1="57" x2="210" y2="57" stroke="var(--ps-text-muted)" stroke-width="1.5" marker-end="url(#ah)"/>
                  <rect x="220" y="30" width="140" height="55" rx="8" fill="transparent" stroke="var(--ps-sky)" stroke-width="2"/>
                  <text x="290" y="55" text-anchor="middle" font-family="system-ui, sans-serif" font-size="13" font-weight="600" fill="var(--ps-text)">Frontend</text>
                  <text x="290" y="70" text-anchor="middle" font-family="system-ui, sans-serif" font-size="11" fill="var(--ps-text-muted)">(FastAPI)</text>
                  <line x1="360" y1="57" x2="430" y2="57" stroke="var(--ps-text-muted)" stroke-width="1.5" marker-end="url(#ah)"/>
                  <rect x="440" y="30" width="140" height="55" rx="8" fill="transparent" stroke="var(--ps-sky)" stroke-width="2"/>
                  <text x="510" y="55" text-anchor="middle" font-family="system-ui, sans-serif" font-size="13" font-weight="600" fill="var(--ps-text)">API Server</text>
                  <text x="510" y="70" text-anchor="middle" font-family="system-ui, sans-serif" font-size="11" fill="var(--ps-text-muted)">(FastAPI)</text>
                  <!-- API Server connections down -->
                  <line x1="475" y1="85" x2="175" y2="150" stroke="var(--ps-sky)" stroke-width="1.5" marker-end="url(#ah-blue)"/>
                  <line x1="510" y1="85" x2="370" y2="150" stroke="var(--ps-sky)" stroke-width="1.5" marker-end="url(#ah-blue)"/>
                  <line x1="545" y1="85" x2="560" y2="150" stroke="var(--ps-sky)" stroke-width="1.5" marker-end="url(#ah-blue)"/>
                  <!-- Row 2: PostgreSQL, Valkey, ADSB-Sync -->
                  <rect x="100" y="155" width="140" height="55" rx="8" fill="transparent" stroke="var(--ps-sky)" stroke-width="2"/>
                  <text x="170" y="180" text-anchor="middle" font-family="system-ui, sans-serif" font-size="13" font-weight="600" fill="var(--ps-text)">PostgreSQL</text>
                  <text x="170" y="195" text-anchor="middle" font-family="system-ui, sans-serif" font-size="11" fill="var(--ps-text-muted)">Database</text>
                  <rect x="300" y="155" width="140" height="55" rx="8" fill="transparent" stroke="var(--ps-sky)" stroke-width="2"/>
                  <text x="370" y="180" text-anchor="middle" font-family="system-ui, sans-serif" font-size="13" font-weight="600" fill="var(--ps-text)">Valkey</text>
                  <text x="370" y="195" text-anchor="middle" font-family="system-ui, sans-serif" font-size="11" fill="var(--ps-text-muted)">Cache</text>
                  <rect x="490" y="155" width="140" height="55" rx="8" fill="transparent" stroke="var(--ps-sky)" stroke-width="2"/>
                  <text x="560" y="180" text-anchor="middle" font-family="system-ui, sans-serif" font-size="13" font-weight="600" fill="var(--ps-text)">ADSB-Sync</text>
                  <text x="560" y="195" text-anchor="middle" font-family="system-ui, sans-serif" font-size="11" fill="var(--ps-text-muted)">Service</text>
                  <!-- ADSB-Sync → Valkey -->
                  <line x1="490" y1="182" x2="440" y2="182" stroke="var(--ps-sky)" stroke-width="1.5" marker-end="url(#ah-blue)"/>
                  <!-- ADSB-Sync → OpenSky -->
                  <line x1="560" y1="210" x2="560" y2="265" stroke="var(--ps-text-muted)" stroke-width="1.5" marker-end="url(#ah)"/>
                  <!-- Row 3: OpenSky -->
                  <rect x="490" y="270" width="140" height="50" rx="8" fill="transparent" stroke="var(--ps-text-muted)" stroke-width="2" stroke-dasharray="6 3"/>
                  <text x="560" y="293" text-anchor="middle" font-family="system-ui, sans-serif" font-size="13" font-weight="600" fill="var(--ps-text)">OpenSky</text>
                  <text x="560" y="307" text-anchor="middle" font-family="system-ui, sans-serif" font-size="11" fill="var(--ps-text-muted)">Network</text>
                </svg>
            </div>
            <div class="lg:col-span-5">
                <h6 class="mb-3 text-[var(--ps-sky)]">
                    <i class="bi bi-stack mr-2"></i>Technology Stack
                </h6>
                <ul class="list-none space-y-2">
                    <li>
                        <i class="bi bi-check-circle text-[var(--ps-green)] mr-2"></i>
                        <strong>Frontend:</strong> FastAPI + Jinja2 + Tailwind CSS
                    </li>
                    <li>
                        <i class="bi bi-check-circle text-[var(--ps-green)] mr-2"></i>
                        <strong>API Server:</strong> FastAPI + SQLAlchemy 2.0
                    </li>
                    <li>
                        <i class="bi bi-check-circle text-[var(--ps-green)] mr-2"></i>
                        <strong>Database:</strong> PostgreSQL 17
                    </li>
                    <li>
                        <i class="bi bi-check-circle text-[var(--ps-green)] mr-2"></i>
                        <strong>Cache:</strong> Valkey 8 (Redis-compatible)
                    </li>
                    <li>
                        <i class="bi bi-check-circle text-[var(--ps-green)] mr-2"></i>
                        <strong>Data Source:</strong> OpenSky Network API
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Demo Instructions -->
<div class="card mb-4">
    <div class="card-header">
        <i class="bi bi-lightbulb mr-2"></i>Micro-Segmentation Demo
    </div>
    <div class="card-body">
        <p>Use this page to demonstrate NSX micro-segmentation capabilities:</p>
        <ol class="list-decimal list-inside space-y-2 mb-0">
            <li>
                <strong>Baseline:</strong> All connections should show as <span class="badge bg-success">Connected</span>
            </li>
            <li>
                <strong>Apply Firewall Rule:</strong> Block traffic between API Server and PostgreSQL (TCP 5432)
            </li>
            <li>
                <strong>Observe:</strong> Click "Test Connections" to see the blocked connection turn <span class="badge bg-danger">Blocked</span>
            </li>
            <li>
                <strong>Remove Rule:</strong> Remove the firewall rule and test again to restore connectivity
            </li>
        </ol>
    </div>
</div>

{% if connectivity %}
<!-- Connection Details Table -->
<div class="card">
    <div class="card-header">
        <div class="flex flex-col sm:flex-row items-center gap-4 w-full">
            <div class="shrink-0">
                {% if connectivity.summary.status == 'healthy' %}
                <div class="status-card healthy" style="padding: 1rem;">
                    <i class="bi bi-shield-check text-2xl"></i>
                </div>
                {% elif connectivity.summary.status == 'degraded' %}
                <div class="status-card degraded" style="padding: 1rem;">
                    <i class="bi bi-shield-exclamation text-2xl"></i>
                </div>
                {% else %}
                <div class="status-card unhealthy" style="padding: 1rem;">
                    <i class="bi bi-shield-x text-2xl"></i>
                </div>
                {% endif %}
            </div>
            <div class="flex-1">
                <div class="mb-1">
                    {% if connectivity.summary.blocked == 0 %}
                    <span class="text-[var(--ps-green)]">All Connections Active</span>
                    {% elif connectivity.summary.connected > 0 %}
                    <span class="text-[var(--ps-amber)]">Partial Connectivity</span>
                    {% else %}
                    <span class="text-[var(--ps-red)]">Connections Blocked</span>
                    {% endif %}
                </div>
                <p class="text-[var(--ps-text-muted)] mb-0">
                    <span class="badge bg-success mr-2">{{ connectivity.summary.connected + 2 }} Connected</span>
                    {% if connectivity.summary.blocked > 0 %}
                    <span class="badge bg-danger">{{ connectivity.summary.blocked }} Blocked</span>
                    {% endif %}
                </p>
            </div>
            <div class="shrink-0 text-right flex items-center gap-3">
                <div>
                    <small class="text-[var(--ps-text-muted)] block">Last tested</small>
                    <small>{{ connectivity.timestamp }}</small>
                </div>
                <button onclick="location.reload()" class="btn btn-primary">
                    <i class="bi bi-arrow-clockwise mr-2"></i>Test
                </button>
            </div>
        </div>
    </div>
    <div class="table-responsive">
        <table class="table mb-0">
            <thead>
                <tr>
                    <th>Status</th>
                    <th>Source</th>
                    <th></th>
                    <th>Destination</th>
                    <th>Port</th>
                    <th>Protocol</th>
                    <th>Latency</th>
                    <th>Details</th>
                </tr>
            </thead>
            <tbody>
                <!-- Browser -> Frontend (implicit) -->
                <tr>
                    <td>
                        <span class="badge bg-success">
                            <i class="bi bi-check-circle mr-1"></i>Connected
                        </span>
                    </td>
                    <td><i class="bi bi-person mr-2"></i>Browser</td>
                    <td><i class="bi bi-arrow-right" style="color: var(--ps-green);"></i></td>
                    <td><i class="bi bi-window mr-2"></i>Frontend</td>
                    <td><code>8080</code></td>
                    <td>HTTP</td>
                    <td><span class="text-[var(--ps-green)]">&lt; 10 ms</span></td>
                    <td><small class="text-[var(--ps-text-muted)]">Page loaded successfully</small></td>
                </tr>
                <!-- Frontend -> API (implicit) -->
                <tr>
                    <td>
                        <span class="badge bg-success">
                            <i class="bi bi-check-circle mr-1"></i>Connected
                        </span>
                    </td>
                    <td><i class="bi bi-window mr-2"></i>Frontend</td>
                    <td><i class="bi bi-arrow-right" style="color: var(--ps-green);"></i></td>
                    <td><i class="bi bi-cpu mr-2"></i>API Server</td>
                    <td><code>8000</code></td>
                    <td>HTTP</td>
                    <td><span class="text-[var(--ps-green)]">&lt; 10 ms</span></td>
                    <td><small class="text-[var(--ps-text-muted)]">Connectivity data returned</small></td>
                </tr>
                <!-- PostgreSQL -> OpenSky (init) -->
                <tr style="opacity: 0.7;">
                    <td>
                        <span class="badge" style="background-color: var(--ps-sky);">
                            <i class="bi bi-clock-history mr-1"></i>Init
                        </span>
                    </td>
                    <td><i class="bi bi-database mr-2"></i>PostgreSQL</td>
                    <td><i class="bi bi-arrow-right" style="color: var(--ps-sky);"></i></td>
                    <td><i class="bi bi-cloud mr-2"></i>OpenSky Network</td>
                    <td><code>443</code></td>
                    <td>HTTPS</td>
                    <td><span class="text-[var(--ps-text-muted)]">-</span></td>
                    <td><small class="text-[var(--ps-text-muted)]">Pulls aircraft metadata CSV on init</small></td>
                </tr>
                {% for conn in connectivity.connections %}
                <tr>
                    <td>
                        {% if conn.status == 'connected' %}
                        <span class="badge bg-success">
                            <i class="bi bi-check-circle mr-1"></i>Connected
                        </span>
                        {% else %}
                        <span class="badge bg-danger">
                            <i class="bi bi-x-circle mr-1"></i>Blocked
                        </span>
                        {% endif %}
                    </td>
                    <td>
                        {% if conn.source == 'ADSB-Sync' %}
                        <i class="bi bi-broadcast mr-2"></i>
                        {% else %}
                        <i class="bi bi-cpu mr-2"></i>
                        {% endif %}
                        {{ conn.source }}
                    </td>
                    <td>
                        <i class="bi bi-arrow-right" style="color: var(--ps-{{ 'green' if conn.status == 'connected' else 'red' }});"></i>
                    </td>
                    <td>
                        {% if conn.destination == 'PostgreSQL' %}
                        <i class="bi bi-database mr-2"></i>
                        {% elif conn.destination == 'Valkey' %}
                        <i class="bi bi-lightning-charge mr-2"></i>
                        {% elif conn.destination == 'ADSB-Sync' %}
                        <i class="bi bi-broadcast mr-2"></i>
                        {% else %}
                        <i class="bi bi-cloud mr-2"></i>
                        {% endif %}
                        {{ conn.destination }}
                    </td>
                    <td><code>{{ conn.port }}</code></td>
                    <td>{{ conn.protocol }}</td>
                    <td>
                        {% if conn.status == 'connected' %}
                        <span class="text-[var(--ps-green)]">{{ conn.latency_ms }} ms</span>
                        {% else %}
                        <span class="text-[var(--ps-red)]">-</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if conn.error %}
                        <small class="text-[var(--ps-red)]">{{ conn.error }}</small>
                        {% else %}
                        <small class="text-[var(--ps-text-muted)]">OK</small>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{% else %}
<!-- Connection Failed -->
<div class="alert alert-danger flex items-center">
    <i class="bi bi-exclamation-triangle mr-2"></i>
    Unable to connect to API server. Please ensure all services are running.
</div>
{% endif %}

{% endblock %}
